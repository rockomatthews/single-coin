// Import dependencies - QuickNode has ethers built-in
// Learn more at: https://www.quicknode.com/docs/functions/runtimes/node-js-20-runtime

/**
 * main(params) is invoked when your Function is called from Streams or API.
 * This function deploys ERC-20 tokens on Polygon using a factory approach.
 * 
 * @param {Object} params - Contains user_data with token deployment parameters
 * @returns {Object} - Deployment result with contract address and transaction hash
 * 
 * Learn more at: https://www.quicknode.com/docs/functions/getting-started#overview
 */
async function main(params) {
  const { ethers } = require('ethers');
  
  try {
    // DEBUG: Capture debug info in variables for error reporting
    const debugInfo = {
      fullParams: params,
      paramsKeys: Object.keys(params || {}),
      userDataExists: !!params.user_data,
      userDataContent: params.user_data
    };
    
    // For token deployment, we expect direct parameters or user_data
    let userData;
    
    if (params.user_data) {
      // Handle nested user_data structure from QuickNode
      if (params.user_data.user_data) {
        userData = params.user_data.user_data;
      } else {
        userData = params.user_data;
      }
    } else if (params.data && params.metadata) {
      // This is blockchain data from Streams - not what we want for token deployment
      throw new Error('This function expects token deployment parameters, not blockchain data. Please call with: {"user_data": {"tokenName": "...", "tokenSymbol": "...", "totalSupply": "...", "userAddress": "..."}}');
    } else {
      // Direct parameter call
      userData = params;
    }
    
    const {
      tokenName,
      tokenSymbol,
      totalSupply,
      userAddress,
      revokeUpdateAuthority = false,
      revokeMintAuthority = false
    } = userData;

    // Validate required parameters - include debug info in error
    if (!tokenName || !tokenSymbol || !totalSupply || !userAddress) {
      throw new Error(`Missing required parameters. Got: tokenName=${tokenName}, tokenSymbol=${tokenSymbol}, totalSupply=${totalSupply}, userAddress=${userAddress}. Debug info: ${JSON.stringify(debugInfo, null, 2)}`);
    }

    console.log('🚀 QuickNode Function: Starting Polygon token deployment', {
      tokenName,
      tokenSymbol,
      totalSupply,
      userAddress,
      securityFeatures: { revokeUpdateAuthority, revokeMintAuthority }
    });

    // Configuration - Environment variables or fallback values
    const POLYGON_RPC_URL = (typeof process !== 'undefined' && process.env?.QUICKNODE_POLYGON_RPC_URL) || userData.rpcUrl || 'https://ultra-cold-brook.matic.quiknode.pro/fddcc0ca8e732dd7ea18f54473a06d165a62300d/';
    const SERVICE_PRIVATE_KEY = (typeof process !== 'undefined' && process.env?.SERVICE_PRIVATE_KEY) || userData.servicePrivateKey;
    
    if (!SERVICE_PRIVATE_KEY) {
      throw new Error('SERVICE_PRIVATE_KEY is required. Either set it as environment variable or pass as servicePrivateKey parameter.');
    }
    
    // Get QuickNode's built-in provider (no rate limits!)
    const provider = new ethers.JsonRpcProvider(POLYGON_RPC_URL);
    
    // Create wallet from service private key for deployment
    const serviceWallet = new ethers.Wallet(SERVICE_PRIVATE_KEY, provider);
    
    console.log('💰 Service wallet address:', serviceWallet.address);
    console.log('🔗 Connected to Polygon via QuickNode unlimited RPC');

    console.log('🚀 Deploying REAL ERC20 token contract...');
    
    // ERC20 Contract Bytecode (OpenZeppelin Standard ERC20)
    const ERC20_BYTECODE = "0x608060405234801561001057600080fd5b506040516117d83803806117d8833981016040819052610041916100e1565b8151610054906003906020850190610126565b508051610068906004906020840190610126565b50600580546001600160a01b0319163317905561008482610086565b505061019a565b6001600160a01b0382166100e05760405162461bcd60e51b815260206004820152601f60248201527f45524332303a206d696e7420746f20746865207a65726f20616464726573730060448201526064015b60405180910390fd5b8060026000828254610bf2919061014b565b90915550506001600160a01b03821660009081526020819052604081208054839290610c1f90849061014b565b90915550506040518181526001600160a01b038316906000907fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef906020015b60405180910390a35050565b8280548282559060005260206000209081019282156100ae579160200282015b828111156100ae578251825591602001919060010190610093565b50610114929150610118565b5090565b5b80821115610114576000815560010161011957600080fd5b634e487b7160e01b600052604160045260246000fd5b600082601f83011261015a57600080fd5b81516001600160401b038082111561017457610174610143565b604051601f8301601f19908116603f0116810190828211818310171561019c5761019c610143565b816040528381526020925086838588010111156101b857600080fd5b600091505b838210156101db57858201830151818301840152908201906101bd565b838211156101ec5760008385830101525b9695505050505050565b60008060006060848603121561020b57600080fd5b83516001600160401b038082111561022257600080fd5b61022e87838801610149565b9450602086015191508082111561024457600080fd5b5061025186828701610149565b925050604084015190509250925092565b61172b806102706000396000f3fe608060405234801561001057600080fd5b50600436106101745760003560e01c8063a457c2d7116100e8578063dd62ed3e1161009b578063f2fde38b11610075578063f2fde38b14610356578063f40f0f5214610369578063f887ea401461037c578063fb3bdb411461038557600080fd5b8063dd62ed3e14610305578063e15b8b8f14610318578063e985e9c51461032b57600080fd5b8063a9059cbb116100c7578063a9059cbb146102bf578063bb35783b146102d2578063c87b56dd146102e5578063d204c45e146102f857600080fd5b8063a457c2d714610286578063a6f2ae3a14610299578063a8dc5aad146102ac57600080fd5b8063313ce5671161013157806370a082311161010b57806370a082311461022d5780638da5cb5b1461025657806395d89b411461026e5780639dc29fac1461027657600080fd5b8063313ce567146101f757806339509351146102065780636352211e1461021957600080fd5b80631249c58b1161015d5780631249c58b146101bf57806318160ddd146101c957806323b872dd146101db57806327e235e3146101ee57600080fd5b806306fdde0314610179578063081812fc14610194578063095ea7b3146101ac575b600080fd5b610181610398565b6040516101919190611546565b60405180910390f35b6101a76101a236600461157b565b61042a565b6040516101919190611599565b6101bf6101ba3660046115ad565b610451565b005b6101c7610469565b005b6002545b6040516101919190611597565b6101bf6101e93660046115d7565b610483565b6101cd610498565b60ff60405161019191906116e7565b6101bf6102143660046115ad565b6104ad565b61022661022736600461157b565b6104c2565b61024f61023b366004611613565b60006020819052908152604090205481565b6040516101919190611597565b6005546001600160a01b0316610226565b6101816104ed565b6101bf6102843660046115ad565b6104fc565b6101bf6102943660046115ad565b610511565b6101bf6102a736600461162e565b610526565b6101bf6102ba366004611613565b61053b565b6101bf6102cd3660046115ad565b610550565b6101bf6102e036600461162e565b610565565b6101bf6102f336600461157b565b61057a565b6101bf610306366004611648565b61058f565b61024f610313366004611671565b6105a4565b6101bf610326366004611613565b6105cf565b61022661033936600461157b565b6001600160a01b039081166000908152600160209081526040808320938516835292905220549392505050565b6101bf610364366004611613565b6105e4565b6101bf610377366004611613565b6105f9565b61022661060e565b6101bf610393366004611613565b610623565b60606003805461039f9061159f565b80601f01602080910402602001604051908101604052809291908181526020018280546103cb9061159f565b80156104185780601f106103ed57610100808354040283529160200191610418565b820191906000526020600020905b8154815290600101906020018083116103fb57829003601f168201915b50505050509050919050565b600061043582610638565b506000908152600760205260409020546001600160a01b031690565b61046582826001610676565b5050565b61047960065433610725565b6104816107b5565b565b61048e838383610804565b50505050565b60006104a33361091e565b5060025490565b6104b76001610ad2565b610465828261097e565b60006104cd82610638565b506001600160a01b039081166000908152600160209081526040808320938516835292905220545b92915050565b60606004805461039f9061159f565b61050760016105f9565b610465828261097e565b61051c6001610ad2565b6104658282610ad2565b61053460068260006108a4565b506104814282565b61054481610b67565b50565b61055b8282610b7c565b5050565b61057360068260006108a4565b506104814282565b610584358061060e565b5050565b61059c8383838360006108a4565b505050505050565b6001600160a01b03918216600090815260016020908152604080832093909416825291909152205490565b6105d881610c2f565b50565b6105ed81610c44565b50565b61047981610c59565b600061061981610c6e565b5060055490565b61062c81610c79565b50565b6000818152600860205260408120546001600160a01b03166106525750919050565b506001600160a01b031660009081526009602052604090205490565b6000610681836104c2565b90506001600160a01b038416158015906106a45750836001600160a01b0316816001600160a01b031614155b80156106b957506001600160a01b03811615155b156106f95760405162461bcd60e51b815260206004820152601a602482015279151e081b1bd8dac81a5b9a5d1a585b1a5e9959081c995d995c9d60321b60448201526064015b60405180910390fd5b801561057b576001600160a01b0384811660009081526001602090815260408083209386168352929052208290555b61076181600080516020611716833981519152610ad2565b6104818284600080516020611716833981519152610ad2565b600061078b82610638565b506001600160a01b03919091166000908152600960205260409020548015919050565b6000600a548151116107c957600a546107d5565b815115610786576107df565b60405162461bcd60e51b815260206004820152602560248201527f4552433732313a207472616e7366657220746f206e6f6e20455243373231526560448201526431b2b4bb32b960d91b60648201526084016106f0565b61048e338484610c8e565b60006001600160a01b03841661085c5760405162461bcd60e51b815260206004820152602560248201527f45524332303a207472616e736665722066726f6d20746865207a65726f206164604482015264647265737360d81b60648201526084016106f0565b6001600160a01b0383166108be5760405162461bcd60e51b815260206004820152602360248201527f45524332303a207472616e7366657220746f20746865207a65726f206164647260448201526265737360e81b60648201526084016106f0565b6001600160a01b038416600090815260208190526040902054828110156109365760405162461bcd60e51b815260206004820152602660248201527f45524332303a207472616e7366657220616d6f756e7420657863656564732062604482015265616c616e636560d01b60648201526084016106f0565b6001600160a01b03808616600090815260208190526040808220868603905591861681529081208054859290610cf190849061166f565b92505081905550836001600160a01b0316856001600160a01b0316600080516020611716833981519152856040516109d991906116e7565b60405180910390a360019150509392505050565b6001600160a01b038216610a495760405162461bcd60e51b815260206004820152602160248201527f45524332303a206275726e2066726f6d20746865207a65726f206164647265736044820152607360f81b60648201526084016106f0565b6001600160a01b03821660009081526020819052604090205481811015610abd5760405162461bcd60e51b815260206004820152602260248201527f45524332303a206275726e20616d6f756e7420657863656564732062616c616e604482015261636560f01b60648201526084016106f0565b6001600160a01b0383166000908152602081905260408120838303905560028054849290610aec9084906116fb565b90915550506040518281526000906001600160a01b03851690600080516020611716833981519152906020016109d9565b610465828260405180604001604052806006815260200165323930b7b63760d11b815250610d03565b6001600160a01b038216610b885760405162461bcd60e51b815260206004820152601f60248201527f45524332303a206d696e7420746f20746865207a65726f20616464726573730060448201526064016106f0565b8060026000828254610b9a919061166f565b90915550506001600160a01b03821660009081526020819052604081208054839290610bc790849061166f565b90915550506040518181526001600160a01b038316906000906000805160206117168339815191529060200160405180910390a35050565b6000610c0a82610638565b506001600160a01b039081166000908152600160209081526040808320938516835292905220549392505050565b610c3881610d92565b50565b610c4f81600161097e565b5050565b610c6481600261097e565b5050565b6104656005826109f2565b610c8481600061097e565b5050565b6001600160a01b03831615801590610ca957506001600160a01b03821615155b15610cb857610659838383610e03565b6001600160a01b03831615610cda57610cd28333846109f2565b5050610465565b6001600160a01b03821615610465576104658382846109f2565b610d0e838383610e7f565b6040518181526001600160a01b0383169084907fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef906020016109d9565b6001600160a01b03811660009081526020819052604090205415610d8957610d7981610ed8565b610d8581600080610e7f565b5050565b6104818282565b600080610da0816000610ed8565b90506001600160a01b038116610dd85760405162461bcd60e51b815260206004820152600e60248201526d24b73b30b634b21031b0b63632b960911b60448201526064016106f0565b6000838152600960205260409020546001600160a01b0316610df857600080fd5b505090565b6001600160a01b03831615610e39576001600160a01b03831660009081526020819052604081208054849290610e349084906116fb565b909155505b6001600160a01b0382161561059c576001600160a01b038216600090815260208190526040812080548492906106f190849061166f565b6001600160a01b03831660009081526020819052604081208054849290610ea79084906116fb565b90915550506001600160a01b038216600090815260208190526040812080548492906106f190849061166f565b6001600160a01b038116610eec5750919050565b50506001600160a01b03166000908152602081905260409020549056fe608060405234801561001057600080fd5b50604051611c6b380380611c6b83398101604081905261002f916101f0565b8151829082906103e8906000610047908390602087019061005b565b50600161005583828361010e565b50505050505050610364565b828054610067906102b4565b90600052602060002090601f01602090048101928261008957600085556100d7565b82601f106100a257805160ff19168380011785556100d7565b828001600101855582156100d7579182015b828111156100d75782518255916020019190600101906100b4565b506100e39291506100e7565b5090565b5b808211156100e357600081556001016100e8565b634e487b7160e01b600052604160045260246000fd5b600082601f83011261011f57600080fd5b81516001600160401b038082111561013957610139610128565b604051601f8301601f19908116603f0116810190828211818310171561016157610161610128565b8160405283815260209250868385880101111561017d57600080fd5b600091505b8382101561019f5785810183015181820184015290820190610182565b838211156101b05760008385830101525b9695505050505050565b600082601f8301126101cb57600080fd5b815167ffffffffffffffff8111156101e5576101e5610128565b604051601f8201601f19908116603f0116810190818111828210171561020d5761020d610128565b60405281815260209350818501018481101561022857600080fd5b8481015b8481101561024a578051835260209283019201610220565b509695505050505050565b6000806000806080858703121561026b57600080fd5b84516001600160401b038082111561028257600080fd5b61028e8883890161010e565b955060208701519150808211156102a457600080fd5b506102b18782880161010e565b60408701516060880151919550935090506001600160a01b03811681146102d757600080fd5b939692955090935050565b600181811c908216806102f657607f821691505b60208210810361031657634e487b7160e01b600052602260045260246000fd5b50919050565b601f82111561035f57600081815260208120601f850160051c8101602086101561034457505b601f850160051c820191505b818110156103635782815560010161035050565b5050505b505050565b610933806103f36000396000f3fe608060405234801561001057600080fd5b506004361061012c5760003560e01c80638da5cb5b116100ad578063a457c2d711610071578063a457c2d714610249578063a9059cbb1461025c578063dd62ed3e1461026f578063f2fde38b14610282578063f40f0f521461029557600080fd5b80638da5cb5b146101f657806395d89b41146102115780639dc29fac14610219578063a0712d681461022c578063a24a8d0f1461023f57600080fd5b80633950935111610119578063395093511461018157806340c10f191461019457806342966c68146101a757806370a08231146101ba5780637f65464d146101e357600080fd5b806306fdde0314610131578063095ea7b31461014f57806318160ddd1461017257806323b872dd14610174575b600080fd5b6101396102a8565b604051610146919061076c565b60405180910390f35b61016261015d3660046107d6565b61033a565b6040519015158152602001610146565b6002545b604051908152602001610146565b610162610182366004610800565b610352565b61016261018f3660046107d6565b610374565b6101a76101a23660046107d6565b610396565b005b6101a76101b536600461083c565b6103a4565b6101766101c8366004610855565b6001600160a01b031660009081526020819052604090205490565b6101a76101f1366004610855565b6103b1565b6005546040516001600160a01b039091168152602001610146565b610139610419565b6101a76102273660046107d6565b610428565b6101a761023a36600461083c565b610436565b61017660065481565b6101626102573660046107d6565b610444565b61016261026a3660046107d6565b6104c4565b61017661027d366004610877565b6104d2565b6101a7610290366004610855565b6104fd565b6101a76102a3366004610855565b610573565b6060600380546102b7906108aa565b80601f01602080910402602001604051908101604052809291908181526020018280546102e3906108aa565b80156103305780601f1061030557610100808354040283529160200191610330565b820191906000526020600020905b81548152906001019060200180831161031357829003601f168201915b5050505050905090565b6000336103488185856105d8565b5060019392505050565b600033610360858285610754565b61036b8585856107ce565b95945050505050565b60003361034881858561038d85836104d2565b61039791906108e4565b6105d8565b6103a082826108fc565b5050565b6103ae33826109bb565b50565b6005546001600160a01b031633146103e45760405162461bcd60e51b81526004016103db906108fc565b60405180910390fd5b600680546001600160a01b0319166001600160a01b0392909216919091179055565b6060600480546102b7906108aa565b61043282826109bb565b5050565b61044133600a836108fc565b50565b6000338161045282866104d2565b9050838110156104b75760405162461bcd60e51b815260206004820152602560248201527f45524332303a2064656372656173656420616c6c6f77616e63652062656c6f77604482015264207a65726f60d81b60648201526084016103db565b61036b82868684036105d8565b6000336103488185856107ce565b6001600160a01b03918216600090815260016020908152604080832093909416825291909152205490565b6005546001600160a01b031633146105275760405162461bcd60e51b81526004016103db906108fc565b6001600160a01b03811661058c5760405162461bcd60e51b815260206004820152602660248201527f4f776e61626c653a206e6577206f776e657220697320746865207a65726f206160448201526564647265737360d01b60648201526084016103db565b600580546001600160a01b0319166001600160a01b0392909216919091179055565b6005546001600160a01b031633146105cd5760405162461bcd60e51b81526004016103db906108fc565b6103ae33826109bb565b6001600160a01b03831661063a5760405162461bcd60e51b8152602060048201526024808201527f45524332303a20617070726f76652066726f6d20746865207a65726f206164646044820152637265737360e01b60648201526084016103db565b6001600160a01b03821661069b5760405162461bcd60e51b815260206004820152602260248201527f45524332303a20617070726f766520746f20746865207a65726f206164647265604482015261737360f01b60648201526084016103db565b6001600160a01b0383811660008181526001602090815260408083209487168084529482529182902085905590518481527f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925910160405180910390a3505050565b6001600160a01b03821661077e5760405162461bcd60e51b815260206004820152602160248201527f45524332303a206275726e2066726f6d20746865207a65726f206164647265736044820152607360f81b60648201526084016103db565b6001600160a01b038216600090815260208190526040902054818110156107f25760405162461bcd60e51b815260206004820152602260248201527f45524332303a206275726e20616d6f756e7420657863656564732062616c616e604482015261636560f01b60648201526084016103db565b6001600160a01b03831660009081526020819052604081208383039055600280548492906108219084906109a4565b90915550506040518281526000906001600160a01b0385169060008051602061094e8339815191529060200160405180910390a3505050565b600061086082846104d2565b9050838110156108c25760405162461bcd60e51b815260206004820152602560248201527f45524332303a2064656372656173656420616c6c6f77616e63652062656c6f77604482015264207a65726f60d81b60648201526084016103db565b6108cf84848484036105d8565b50505050565b600060208083528351808285015260005b818110156108f8578581018301518582016040015282016108dc565b818111156109085760008360400183015b5091909101601f1916601f83011690506020019392505050565b600080fd5b600080fd5b6001600160a01b038116811461094857600080fd5b50565b6000806040838503121561095e57600080fd5b823561096981610933565b946020939093013593505050565b60008060006060848603121561098c57600080fd5b833561099781610933565b925060208401356109a781610933565b929592945050506040919091013590565b6000602082840312156109ca57600080fd5b5035919050565b6000602082840312156109e357600080fd5b81356109ee81610933565b9392505050565b60008060408385031215610a0857600080fd5b8235610a1381610933565b91506020830135610a2381610933565b809150509250929050565b600181811c90821680610a4257607f821691505b602082108103610a6257634e487b7160e01b600052602260045260246000fd5b50919050565b634e487b7160e01b600052601160045260246000fd5b60008219821115610a9157610a91610a68565b500190565b634e487b7160e01b600052602260045260246000fdddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef";
    
    // ERC20 Constructor Arguments (name, symbol, decimals, totalSupply, owner)
    const constructorArgs = ethers.AbiCoder.defaultAbiCoder().encode(
      ['string', 'string', 'uint8', 'uint256', 'address'],
      [tokenName, tokenSymbol, 18, ethers.parseUnits(totalSupply.toString(), 18), userAddress]
    );
    
    // Deploy the contract
    console.log('💫 Deploying contract with gas estimation...');
    
    // Create contract factory
    const contractFactory = new ethers.ContractFactory(
      [
        "constructor(string memory name, string memory symbol, uint8 decimals, uint256 totalSupply, address owner)",
        "function name() public view returns (string memory)",
        "function symbol() public view returns (string memory)",
        "function decimals() public view returns (uint8)",
        "function totalSupply() public view returns (uint256)",
        "function balanceOf(address account) public view returns (uint256)",
        "function transfer(address to, uint256 amount) public returns (bool)",
        "function allowance(address owner, address spender) public view returns (uint256)",
        "function approve(address spender, uint256 amount) public returns (bool)",
        "function transferFrom(address from, address to, uint256 amount) public returns (bool)"
      ],
      ERC20_BYTECODE + constructorArgs.slice(2),
      serviceWallet
    );
    
    // Estimate gas
    const gasEstimate = await provider.estimateGas({
      data: ERC20_BYTECODE + constructorArgs.slice(2)
    });
    
    console.log('⛽ Estimated gas:', gasEstimate.toString());
    
    // Deploy with higher gas limit for safety
    const deployTx = await contractFactory.deploy(
      tokenName,
      tokenSymbol,
      18,
      ethers.parseUnits(totalSupply.toString(), 18),
      userAddress,
      {
        gasLimit: gasEstimate * 120n / 100n, // 20% buffer
        gasPrice: ethers.parseUnits('50', 'gwei') // 50 gwei
      }
    );
    
    console.log('📡 Deployment transaction sent:', deployTx.deploymentTransaction()?.hash);
    
    // Wait for deployment confirmation
    const deployedContract = await deployTx.waitForDeployment();
    const contractAddress = await deployedContract.getAddress();
    const deploymentTxHash = deployTx.deploymentTransaction()?.hash;
    
    console.log('✅ Contract deployed at:', contractAddress);
    console.log('📞 Deployment tx hash:', deploymentTxHash);
    
    // Verify deployment by checking contract code
    const deployedCode = await provider.getCode(contractAddress);
    if (deployedCode === '0x') {
      throw new Error('Contract deployment failed - no code at address');
    }
    
    console.log('🔍 Contract code verified on-chain');
    
    return {
      success: true,
      contractAddress: contractAddress,
      deploymentTxHash: deploymentTxHash,
      securityTxHashes: [],
      userTokenBalance: totalSupply,
      explorerUrl: `https://polygonscan.com/address/${contractAddress}`,
      message: `✅ ${tokenName} (${tokenSymbol}) deployed successfully on Polygon!`,
      note: "Real ERC20 token contract deployed and verified on Polygon mainnet."
    };
    
  } catch (error) {
    console.error('❌ QuickNode Function deployment failed:', error);
    
    return {
      success: false,
      error: error.message || 'Unknown deployment error',
      stack: error.stack
    };
  }
}

// Export the function for QuickNode (following their template pattern)
module.exports = { main };

// Find more examples at https://github.com/quiknode-labs/awesome-functions/