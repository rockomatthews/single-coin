import { NextRequest, NextResponse } from 'next/server';
import { ethers } from 'ethers';

interface DeploymentRequest {
  name: string;
  symbol: string;
  totalSupply: number;
  decimals?: number;
  owner: string;
  revokeUpdateAuthority?: boolean;
  revokeMintAuthority?: boolean;
  createLiquidity?: boolean;
  liquidityEthAmount?: number;
}

// Reuse Polygon secure ERC-20 bytecode
const SECURE_TOKEN_BYTECODE = "0x60806040526006805461ff001916905534801561001a575f5ffd5b5060405161127438038061127483398101604081905261003991610261565b61004233610095565b600461004e8582610372565b50600561005b8482610372565b506006805460ff1916601217905561007381836100e4565b6001600160a01b038116331461008c5761008c81610095565b50505050610451565b5f80546001600160a01b038381166001600160a01b0319831681178455604051919092169283917f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e09190a35050565b6001600160a01b03821661013e5760405162461bcd60e51b815260206004820152601f60248201527f45524332303a206d696e7420746f20746865207a65726f206164647265737300604482015260640160405180910390fd5b8060035f82825461014f919061042c565b90915550506001600160a01b0382165f908152600160205260408120805483929061017b90849061042c565b90915550506040518181526001600160a01b038316905f907fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef9060200160405180910390a35050565b634e487b7160e01b5f52604160045260245ffd5b5f82601f8301126101e7575f5ffd5b81516001600160401b03811115610200576102006101c4565b604051601f8201601f19908116603f011681016001600160401b038111828210171561022e5761022e6101c4565b604052818152838201602001851015610245575f5ffd5b8160208501602083015e5f918101602001919091529392505050565b5f5f5f5f60808587031215610274575f5ffd5b84516001600160401b03811115610289575f5ffd5b610295878288016101d8565b602087015190955090506001600160401b038111156102b2575f5ffd5b6102be878288016101d8565b60408701516060880151919550935090506001600160a01b03811681146102e3575f5ffd5b939692955090935050565b600181811c9082168061030257607f821691505b60208210810361032057634e487b7160e01b5f52602260045260245ffd5b50919050565b601f82111561036d57805f5260205f20601f840160051c8101602085101561034b5750805b601f840160051c820191505b8181101561036a575f8155600101610357565b50505b505050565b81516001600160401b0381111561038b5761038b6101c4565b61039f8161039984546102ee565b84610326565b6020601f8211600181146103d1575f83156103ba5750848201515b5f19600385901b1c1916600184901b17845561036a565b5f84815260208120601f198516915b8281101561040057878501518255602094850194600190920191016103e0565b508482101561041d57868401515f19600387901b60f8161c191681555b50505050600190811b01905550565b8082018082111561044b57634e487b7160e01b5f52601160045260245ffd5b92915050565b610e168061045e5f395ff3fe608060405234801561000f575f5ffd5b5060043610610106575f3560e01c806370a082311161009e5780638da5cb5b1161006e5780638da5cb5b1461020657806395d89b4114610220578063a9059cbb14610228578063dd62ed3e1461023b578063f2fde38b14610273575f5ffd5b806370a08231146101bb578063715018a6146101e357806379cc6790146101eb5780637d64bcb4146101fe575f5ffd5b806323b872dd116100d957806323b872dd1461016b578063313ce5671461017e57806340c10f191461019357806342966c68146101a8575f5ffd5b806305d2035b1461010a57806306fdde0314610131578063095ea7b31461014657806318160ddd14610159575b5f5ffd5b60065461011c90610100900460ff1681565b60405190151581526020015b60405180910390f35b610139610286565b6040516101289190610c1f565b61011c610154366004610c6f565b610316565b6003545b604051908152602001610128565b61011c610179366004610c97565b61032c565b60065460405160ff9091168152602001610128565b6101a66101a1366004610c6f565b61034f565b005b6101a66101b6366004610cd1565b610420565b61015d6101c9366004610ce8565b6001600160a01b03165f9081526001602052604090205490565b6101a661042d565b6101a66101f9366004610c6f565b610461565b6101a661047a565b5f546040516001600160a01b039091168152602001610128565b610139610534565b61011c610236366004610c6f565b610543565b61015d610249366004610d08565b6001600160a01b039182165f90815260026020908152604080832093909416825291909152205490565b6101a6610281366004610ce8565b61054f565b60606004805461029590610d39565b80601f01602080910402602001604051908101604052809291908181526020018280546102c190610d39565b801561030c5780601f106102e35761010080835404028352916020019161030c565b820191905f5260205f20905b8154815290600101906020018083116102ef57829003601f168201915b5050505050905090565b5f6103223384846105e6565b5060015b92915050565b5f33610339858285610709565b610344858585610799565b506001949350505050565b5f546001600160a01b031633146103815760405162461bcd60e51b815260040161037890610d71565b60405180910390fd5b600654610100900460ff16156103cf5760405162461bcd60e51b8152602060048201526013602482015272135a5b9d1a5b99c81a5cc8199a5b9a5cda1959606a1b6044820152606401610378565b6103d98282610966565b816001600160a01b03167f0f6798a560793a54c3bcfe86a93cde1e73087d944c0ea20544137d41213968858260405161041491815260200190565b60405180910390a25050565b61042a3382610a42565b50565b5f546001600160a01b031633146104565760405162461bcd60e51b815260040161037890610d71565b61045f5f610bd0565b565b61046c823383610709565b6104768282610a42565b5050565b5f546001600160a01b031633146104a35760405162461bcd60e51b815260040161037890610d71565b600654610100900460ff16156104fb5760405162461bcd60e51b815260206004820152601b60248201527f4d696e74696e6720697320616c72656164792066696e697368656400000000006044820152606401610378565b6006805461ff0019166101001790556040517fae5184fba832cb2b1f702aca6117b8d265eaf03ad33eb133f19dde0f5920fa08905f90a1565b60606005805461029590610d39565b5f610322338484610799565b5f546001600160a01b031633146105785760405162461bcd60e51b815260040161037890610d71565b6001600160a01b0381166105dd5760405162461bcd60e51b815260206004820152602660248201527f4f776e61626c653a206e6577206f776e657220697320746865207a65726f206160448201526564647265737360d01b6064820152608401610378565b61042a81610bd0565b6001600160a01b0383166106485760405162461bcd60e51b8152602060048201526024808201527f45524332303a20617070726f76652066726f6d20746865207a65726f206164646044820152637265737360e01b6064820152608401610378565b6001600160a01b0382166106a95760405162461bcd60e51b815260206004820152602260248201527f45524332303a20617070726f766520746f20746865207a65726f206164647265604482015261737360f01b6064820152608401610378565b6001600160a01b038381165f8181526002602090815260408083209487168084529482529182902085905590518481527f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925910160405180910390a3505050565b6001600160a01b038381165f908152600260209081526040808320938616835292905220545f19811461079357818110156107865760405162461bcd60e51b815260206004820152601d60248201527f45524332303a20696e73756666696369656e7420616c6c6f77616e63650000006044820152606401610378565b61079384848484036105e6565b50505050565b6001600160a01b0383166107fd5760405162461bcd60e51b815260206004820152602560248201527f45524332303a207472616e736665722066726f6d20746865207a65726f206164604482015264647265737360d81b6064820152608401610378565b6001600160a01b03821661085f5760405162461bcd60e51b815260206004820152602360248201527f45524332303a207472616e7366657220746f20746865207a65726f206164647260448201526265737360e81b6064820152608401610378565b6001600160a01b0383165f90815260016020526040902054818110156108d65760405162461bcd60e51b815260206004820152602660248201527f45524332303a207472616e7366657220616d6f756e7420657863656564732062604482015265616c616e636560d01b6064820152608401610378565b6001600160a01b038085165f9081526001602052604080822085850390559185168152908120805484929061090c908490610dba565b92505081905550826001600160a01b0316846001600160a01b03167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef8460405161095891815260200190565b60405180910390a350505050565b6001600160a01b0382166109bc5760405162461bcd60e51b815260206004820152601f60248201527f45524332303a206d696e7420746f20746865207a65726f2061646472657373006044820152606401610378565b8060035f8282546109cd9190610dba565b90915550506001600160a01b0382165f90815260016020526040812080548392906109f9908490610dba565b90915550506040518181526001600160a01b038316905f907fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef9060200160405180910390a35050565b6001600160a01b038216610aa25760405162461bcd60e51b815260206004820152602160248201527f45524332303a206275726e2066726f6d20746865207a65726f206164647265736044820152607360f81b6064820152608401610378565b6001600160a01b0382165f9081526001602052604090205481811015610b155760405162461bcd60e51b815260206004820152602260248201527f45524332303a206275726e20616d6f756e7420657863656564732062616c616e604482015261636560f01b6064820152608401610378565b6001600160a01b0383165f908152600160205260408120838303905560038054849290610b43908490610dcd565b90915550506040518281525f906001600160a01b038516907fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef9060200160405180910390a3826001600160a01b03167fcc16f5dbb4873280815c1ee09dbd06736cffcc184412cf7a71a0fdb75d397ca583604051610bc391815260200190565b60405180910390a2505050565b5f80546001600160a01b038381166001600160a01b0319831681178455604051919092169283917f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e09190a35050565b602081525f82518060208401528060208501604085015e5f604082850101526040601f19601f83011684010191505092915050565b80356001600160a01b0381168114610c6a575f5ffd5b919050565b5f5f60408385031215610c80575f5ffd5b610c8983610c54565b946020939093013593505050565b5f5f5f60608486031215610ca9575f5ffd5b610cb284610c54565b9250610cc060208501610c54565b929592945050506040919091013590565b5f60208284031215610ce1575f5ffd5b5035919050565b5f60208284031215610cf8575f5ffd5b610d0182610c54565b9392505050565b5f5f60408385031215610d19575f5ffd5b610d2283610c54565b9150610d3060208401610c54565b90509250929050565b600181811c90821680610d4d57607f821691505b602082108103610d6b57634e487b7160e01b5f52602260045260245ffd5b50919050565b6020808252818101527f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e6572604082015260600190565b634e487b7160e01b5f52601160045260245ffd5b8082018082111561032657610326610da6565b8181038181111561032657610326610da656fea264697066735822122069b5c875b891b79ad1ba021297b01de879471cfce462244686e0e619adde350964736f6c634300081e0033";

const SECURE_TOKEN_ABI = [
  "constructor(string memory name_, string memory symbol_, uint256 initialSupply_, address owner_)",
  "function name() view returns (string)",
  "function symbol() view returns (string)",
  "function decimals() view returns (uint8)",
  "function totalSupply() view returns (uint256)",
  "function balanceOf(address) view returns (uint256)",
  "function transfer(address, uint256) returns (bool)",
  "function approve(address, uint256) returns (bool)",
  "function allowance(address, address) view returns (uint256)",
  "function transferFrom(address, address, uint256) returns (bool)",
  "function finishMinting() external",
  "function renounceOwnership() external",
  "function owner() view returns (address)",
  "function mintingFinished() view returns (bool)",
  "function mint(address, uint256) external",
  "function burn(uint256) external",
  "function burnFrom(address, uint256) external"
];

export async function POST(request: NextRequest) {
  try {
    const body: DeploymentRequest = await request.json();
    const { name, symbol, totalSupply, owner, revokeUpdateAuthority, revokeMintAuthority } = body;

    if (!name || !symbol || !totalSupply || !owner) {
      return NextResponse.json({ success: false, error: 'Missing required parameters' }, { status: 400 });
    }

    const rpcUrl = process.env.QUICKNODE_ARBITRUM_RPC_URL;
    const privateKey = process.env.ARBITRUM_PRIVATE_KEY;
    if (!rpcUrl) return NextResponse.json({ success: false, error: 'QUICKNODE_ARBITRUM_RPC_URL not set' }, { status: 500 });
    if (!privateKey) return NextResponse.json({ success: false, error: 'ARBITRUM_PRIVATE_KEY not set' }, { status: 500 });

    const provider = new ethers.JsonRpcProvider(rpcUrl);
    const wallet = new ethers.Wallet(privateKey, provider);

    const totalSupplyWei = ethers.parseUnits(totalSupply.toString(), 18);
    const contractFactory = new ethers.ContractFactory(SECURE_TOKEN_ABI, SECURE_TOKEN_BYTECODE, wallet);
    const contract = await contractFactory.deploy(name, symbol, totalSupplyWei, owner, { gasLimit: 2_000_000 });

    await contract.waitForDeployment();
    const contractAddress = await contract.getAddress();
    const deploymentTx = contract.deploymentTransaction();

    let securityTxHash: string | undefined;
    if (revokeMintAuthority) {
      const finishMintingFunction = contract.getFunction('finishMinting');
      const finishTx = await finishMintingFunction({ gasLimit: 150_000 });
      await finishTx.wait();
      securityTxHash = finishTx.hash;
    }
    if (revokeUpdateAuthority) {
      const renounceOwnershipFunction = contract.getFunction('renounceOwnership');
      const renounceTx = await renounceOwnershipFunction({ gasLimit: 150_000 });
      await renounceTx.wait();
      securityTxHash = securityTxHash || renounceTx.hash;
    }

    return NextResponse.json({
      success: true,
      tokenAddress: contractAddress,
      txHash: deploymentTx?.hash,
      securityTxHash,
      explorer_url: `https://arbiscan.io/token/${contractAddress}`
    });
  } catch (error) {
    console.error('❌ Arbitrum deploy error:', error);
    return NextResponse.json({ success: false, error: error instanceof Error ? error.message : 'Unknown deployment error' }, { status: 500 });
  }
}
